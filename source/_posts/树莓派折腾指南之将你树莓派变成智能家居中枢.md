title: 树莓派折腾指南之将你树莓派变成智能家居中枢
date: 2018-01-13 17:45:13
tags: [树莓派]
category: [硬件]
---
# 将你树莓派变成智能家居中枢
树莓派由于本身足够的小巧且扩展性极高，所以它智能家居方面的应用具有天然的优势。对于喜欢折腾和 Geek 的人的而言，其扩展性具有无比的吸引力。
<!--more-->

这次我们就来尝试将树莓派变身为智能家居的管理中枢，将其桥接到苹果家的 Home 应用当中，使用 Siri 来控制所有的智能家居。

由于 Apple 家认证的智能家居暂时承担不起，而刚好又可以使用树莓派加上 `HomeBridge` 相关的框架来将小米的智能家居产品加入 `HomeKit` 。

我使用的是小米智能家居全家桶套装，极客学院送的2017年元旦讲师礼物，在此表示感谢！其包含内容产品主要有：多功能网关，人体传感器，智能插座，无线开关，门窗传感器。效果图如下：
![-w629](http://7xjsv3.com1.z0.glb.clouddn.com/15158306050366.jpg)

![-w451](http://7xjsv3.com1.z0.glb.clouddn.com/15158306313468.jpg)


用习惯之后，不得不说确实很方便，特别是寒冷的冬天不用起床就能开关灯。

下面就进入正题，如何将你的树莓派变身智能家居桥接中枢。

## 准备工作
### 材料准备
硬件：

* Raspberry Pi
* 小米智能家居产品

软件：
* [HomeBridge](https://github.com/nfarina/homebridge)
* [homebridge-mi-aqara](https://github.com/YinHangCode/homebridge-mi-aqara)


### 基本步骤
1. 硬件准备和连接
2. 软件环境和依赖安装
3. 安装运行 `Homebridge`
4. 安装及配置 `homebridge-mi-aqara`
5. 测试及后台运行
6. 其他

## 步骤一：硬件准备和连接
首先将你的[树莓派安装好系统并配置好](https://www.jianshu.com/p/b62a8229a74c)，最好可以使用 SSR 全局代理可以科学上网，这样可以改善你的树莓派网络环境，一定程度加快安装过程。具体的方法参考[之前的文章](https://www.jianshu.com/p/445256a2367b)。

使用 SSH 远程连接你的树莓派：

```
ssh pi@raspberrypi.local
```
更新树莓派相关依赖环境

```
sudo apt-get update
sudo apt-get upgrade
```

完成之后进入下一步。

## 步骤二：软件环境和依赖安装
首先安装这两个库使用的都是 `Node` 环境的 `npm` 工具，因此要先安装 `Node`，命令如下：

```
curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
sudo apt-get install -y nodejs
```
其次需要安装 `avahi` 包

```
sudo apt-get install libavahi-compat-libdnssd-dev
```

如果上述包安装出现错误，可以参考这里的[解决方法](https://stackoverflow.com/questions/26571326/how-do-i-resolve-the-following-packages-have-unmet-dependencies)

尝试使用 

```
sudo aptitude install libavahi-compat-libdnssd-dev 
```
命令安装依赖，可能需要将相关软件包降级就可以顺利安装了。

## 步骤三：安装运行 Homebridge
这里具体的安装步骤可以直接去参考其 github 主页的 wiki 内容。简单的来说，步骤如下:
首先可以试一下使用如下命令安装：

```
npm install -g homebridge
```
如果上述命令安装过程出现了错误，那么可以尝试使用如下的命令：

```
cd ~
sudo npm install -g --unsafe-perm homebridge hap-nodejs node-gyp
cd /usr/lib/node_modules/homebridge/
sudo npm install --unsafe-perm bignum
cd /usr/lib/node_modules/hap-nodejs/node_modules/mdns
sudo node-gyp BUILDTYPE=Release rebuild
```
上面的 `/usr/lib/` 目录，如果你不是使用的 `apt-get` 命令安装的 `Node`，需要换成 `/usr/local/lib/` 。
一定要严格安装上述命令的步骤来安装，该切换目录就切换目录。

此时安装应该不会有什么问题了。

## 步骤四：安装及配置 homebridge-mi-aqara
其项目主页是 [homebridge-mi-aqara](https://github.com/YinHangCode/homebridge-mi-aqara)，可以在他的项目主页看到其支持的小米硬件，基本是非常全面的。

安装命令如下：

```
sudo npm install -g homebridge-mi-aqara
```
安装完成之后，需要对其进行基本的配置，从而能够将你的小米全家桶硬件加入到 `HomeBridge` 中。

首先要获取的是 局域网通信协议密码 以及 网关的 `MAC` 地址。

下载米家 APP，连接上你的智能网关以及其他小米智能家居硬件，打开米家 APP，选择你的多功能网关，点击 APP 右上角 `···` 符号，进入 `关于` 选项:
![](http://7xjsv3.com1.z0.glb.clouddn.com/15158331055340.jpg)
![](http://7xjsv3.com1.z0.glb.clouddn.com/15158331906989.jpg)
如上图所示，要不断的点击空白处，片刻后界面就会多了`局域网通信协议`还有`网关信息`等选项。
这时候，分别点选他们，记录你的网关的`局域网通信协议密码`以及`网关的MAC地址`，记得要开启局域网通信协议，记录下密码后，点击确定。网关的 MAC 地址位置如下：
![](http://7xjsv3.com1.z0.glb.clouddn.com/15158337428781.jpg)

上面的 `MAC` 地址去除冒号，全变成小写后记录下来，是一串12位的字符。局域网通信协议密码要保留大小写的记录下来。

记录下上述两个地址之后，就可以开始在终端中配置 `HomeBridge` 的配置文件了。执行的命令如下：

```
sudo mkdir ~/.homebridge 
cd ~/.homebridge      
sudo nano config.json         
```
执行了上述 nano 命令之后，会创建一个配置的 `json` 文件，将以下内粘贴到终端编辑环境中

```
{
    "bridge": {
        "name":"Homebridge",
        "username":"CC:22:3D:E3:CE:23",
        "port":51826,
        "pin":"723-92-124"
    },
    "platforms": [{
        "platform": "MiAqaraPlatform",
        "gateways": {
            "网关 mac 地址": "局域网通信协议密码"
        }
    }]
}
```

将上述的两个参数替换成刚刚你记录下来的即可。其他参数说明：
`name` iOS 的 `Homekit` 在添加配件的时候看到的名字
`username` 如果只是用 `Homebridge`，这里可以是任意一个类似 `MAC` 地址的字符串
`port` 随意，只要不被占用的端口
`pin` iOS 的 `Homekit` 在添加配件时需要的验证码

使用 `Ctrl + o` 保存， `Ctrl + x` 退出。

## 步骤五：测试及后台运行
在终端输入

```
homebridge -D
```

这时候，界面也会出现刚刚你自己填写的 PIN 码
![](http://7xjsv3.com1.z0.glb.clouddn.com/15158339825667.jpg)

进入你 iPhone 或者 iPad 的家庭APP，添加配件，扫码几乎不可能加入成功，直接选择输入 PIN 码，即是输入下方的
![](http://7xjsv3.com1.z0.glb.clouddn.com/15158342592263.jpg)
添加完成之后，你就会看到所有网关所附带的配件了，如我刚开始所配图的一般，不过此时按钮的名字可能是一串英文符号，你需要自己确定各个按钮的作用，给他们一个你想好的名字即可。

但是上面这个只是在测试环境运行，如果断了 SSH，你手机或者 iPad 里面的所有设备都会处于无响应的状态，所以，我们还需要能够在后台运行的 `Homebridge`。

借助 `screen` 工具即可实现这一需求，具体安装命令如下：

```
sudo apt-get install screen
```

安装完成之后，首先开一一个名字叫做 `home` 的窗口，具体的名字你可以随意选取，命令如下：

```
screen -S home
```
然后所打开的 `screen` 进程中开启一个 `homebridge` 进程

```
homebridge -D
```

在 `screen` 里开启的 `homebridge` 不会随着 SSH 关闭而被关闭。使用 `Ctrl+A` 然后按 `d` 就可以跳出来了。

具体关于 `screen` 命令的用法你可以查看这里的文章: [linux 技巧：使用 screen 管理你的远程会话](https://www.ibm.com/developerworks/cn/linux/l-cn-screen/) 及 [Linux screen命令](http://www.runoob.com/linux/linux-comm-screen.html)。

## 其他
完成上面的步骤，此时你只能在你的路由器所在的局域网内完成智能家居的控制，如果要在外网实现操作，及 home 的自动化操作，你需要一台 iPad 作为家居中枢，具体的参考 [自动化和远程访问 HomeKit 配件](https://support.apple.com/zh-cn/HT207057)


上面就是一个利用树莓派实现让 Siri 帮你开关灯的过程，下一步可以使用 `HomeAssistant` 来实现更加智能化和扩展化的家居管理。

更下一步的尝试可能会比较底层一些了：
* 尝试一下扩展温湿度感应器模块
* 尝试使用 `GPIO` 控制 RGB 彩色 LED 灯
* 扩展摄像头模块，尝试一下人脸识别等基本的人工智能
* 扩展私有云存储及远程下载

